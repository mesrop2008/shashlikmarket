<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–µ–Ω—é</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  {% extends 'layout.html' %}
  {% load static %}
  {% block content %}
  <div class="max-w-7xl mx-auto px-4 py-12">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">–ù–∞—à–µ –º–µ–Ω—é</h1>
      <p class="text-xl text-gray-600 max-w-2xl mx-auto">–í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–∏–µ —à–∞—à–ª—ã–∫–∏, –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏—Ö —É–≥–ª—è—Ö –∏–∑
        –æ—Ç–±–æ—Ä–Ω–æ–≥–æ –º—è—Å–∞</p>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="grid grid-cols-2 md:grid-cols-8 gap-2 mb-8 text-center">
      <a href="{% url 'menu' %}" class="py-2 px-4 rounded-lg font-semibold inline-block {% if active_category == 'all' %}
              bg-orange-100
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        üçΩÔ∏è –í—Å—ë –º–µ–Ω—é
      </a>
      <a href="{% url 'shashlik' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'meat' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        üçñ –®–∞—à–ª—ã–∫–∏
      </a>
      <a href="{% url 'kebab' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'kebab' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        üç¢ –õ—é–ª—è-–∫–µ–±–∞–±
      </a>
      <a href="{% url 'sets' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'sets' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        ü•ó –°–µ—Ç—ã
      </a>
      <a href="{% url 'garnirs' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'garnirs' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        üçö –ì–∞—Ä–Ω–∏—Ä—ã
      </a>
      <a href="{% url 'fishes' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'fishes' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        üêü –†—ã–±–∞
      </a>
      <a href="{% url 'drinks' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'drinks' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        ü•§ –ù–∞–ø–∏—Ç–∫–∏
      </a>
      <a href="{% url 'souces' %}" class="py-2 px-4 rounded-lg inline-block {% if active_category == 'souces' %}
              bg-orange-100 font-semibold
            {% else %}
              bg-gray-100 hover:bg-orange-100
            {% endif %}">
        üßÇ –°–æ—É—Å—ã
      </a>
    </div>

    <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
    {% if products %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for product in products %}
      <div class="group hover:shadow-xl transition-all duration-300 overflow-hidden border-0 shadow-lg rounded-lg"
        data-product-id="{{ product.id }}">
        <div class="relative overflow-hidden">
          <img src="{{ product.image.url }}?f_auto,q_auto,w_300,h_300,c_fill,g_auto" alt="{{ product.name }}"
            loading="lazy" class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-300" />
          <div class="absolute top-4 right-4 bg-orange-600 text-white px-3 py-1 rounded-full font-semibold">{{product.price }}‚ÇΩ</div>
        </div>

        <div class="p-6">
          <div class="flex items-start justify-between mb-2">
            <h3 class="text-xl font-bold text-gray-900">{{ product.name }}</h3>
            <span class="px-2 py-1 text-sm bg-gray-100 rounded">{{ product.weight }}–≥</span>
          </div>

          <p class="text-gray-600 mb-4 leading-relaxed">{{ product.description }}</p>

          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-1 text-orange-400">
              ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ <span class="text-gray-500 ml-1">(4.8)</span>
            </div>
            <div class="flex items-center gap-1 text-sm text-gray-500">üïí 25‚Äì30 –º–∏–Ω</div>
          </div>

          {% if product.id|stringformat:"s" in cart %}
          <div
            class="quantity-controls flex items-center justify-between w-full bg-orange-50 border border-orange-300 rounded-lg p-2 mt-2">
            <a href="{% url 'remove_quantity' product.id %}" data-product-id="{{ product.id }}"
              class="remove-quantity-btn w-8 h-8 flex items-center justify-center text-lg font-bold bg-orange-500 text-white rounded-full hover:bg-orange-600 transition cursor-pointer">‚àí</a>
            <span class="product-quantity font-semibold text-gray-800 text-lg select-none">{{ product.quantity }}</span>
            <a href="{% url 'add_to_cart' product.id %}" data-product-id="{{ product.id }}"
              data-product-name="{{ product.name }}"
              class="add-in-controls w-8 h-8 flex items-center justify-center text-lg font-bold bg-orange-500 text-white rounded-full hover:bg-orange-600 transition cursor-pointer">+</a>
          </div>
          {% else %}
          <a href="{% url 'add_to_cart' product.id %}" data-product-id="{{ product.id }}"
            data-product-name="{{ product.name }}"
            class="add-to-cart-button w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold px-4 py-2 rounded text-center block">
            –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
          </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <!-- –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç -->
    <div class="text-center py-12 col-span-full">
      <div class="text-6xl mb-4">üçΩÔ∏è</div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –±–ª—é–¥</h3>
      <p class="text-gray-600">–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –º–µ–Ω—é. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!</p>
    </div>
    {% endif %}
  </div>
  {% endblock %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const csrftoken = getCookie('csrftoken');

      document.body.addEventListener('click', e => {
        const target = e.target;
        const container = target.closest('[data-product-id]');
        const productId = container ? container.dataset.productId : target.dataset.productId;

        // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        if (target.classList.contains('add-btn') || target.classList.contains('add-single-btn')) {
          e.preventDefault();
          fetch(`/add/${productId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' }
          })
            .then(res => res.json())
            .then(data => updateQuantity(productId, data.quantity));
        }

        // –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        if (target.classList.contains('remove-btn')) {
          e.preventDefault();
          fetch(`/removeq/${productId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' }
          })
            .then(res => res.json())
            .then(data => updateQuantity(productId, data.quantity));
        }
      });

      function updateQuantity(productId, quantity) {
        const container = document.querySelector(`[data-product-id='${productId}']`);
        if (!container && quantity > 0) {
          // —Å–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏
          const oldBtn = document.querySelector(`.add-single-btn[data-product-id='${productId}']`);
          if (!oldBtn) return;
          const div = document.createElement('div');
          div.className = "flex items-center justify-between w-full bg-orange-50 border border-orange-300 rounded-lg p-2 mt-2";
          div.dataset.productId = productId;
          div.innerHTML = `
                <button class="remove-btn w-8 h-8 flex items-center justify-center text-lg font-bold bg-orange-500 text-white rounded-full hover:bg-orange-600 transition cursor-pointer">‚àí</button>
                <span class="quantity font-semibold text-gray-800 text-lg select-none">${quantity}</span>
                <button class="add-btn w-8 h-8 flex items-center justify-center text-lg font-bold bg-orange-500 text-white rounded-full hover:bg-orange-600 transition cursor-pointer">+</button>
            `;
          oldBtn.replaceWith(div);
        } else if (container) {
          const span = container.querySelector('.quantity');
          if (span) span.innerText = quantity;

          if (quantity === 0) {
            // –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"
            const btnAdd = document.createElement('button');
            btnAdd.className = 'add-single-btn w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold px-4 py-2 rounded text-center block';
            btnAdd.dataset.productId = productId;
            btnAdd.innerText = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É';
            container.replaceWith(btnAdd);
          }
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    });
  </script>

</body>

</html>